services:
  dyad:
    build: .
    restart: unless-stopped
    init: true
    stop_grace_period: 30s
    environment:
      DYAD_WEB_MODE: "true"
      DYAD_WEB_HOST: "0.0.0.0"
      DYAD_WEB_PORT: "${DYAD_WEB_PORT:-4000}"
      DYAD_DATA_PATH: "/data/dyad"
      DYAD_PUBLIC_HOST: "${DYAD_PUBLIC_HOST:-localhost}"
      DYAD_SERVER_HOSTNAME: "${DYAD_SERVER_HOSTNAME:-localhost}"
      DYAD_PROXY_LISTEN_HOST: "0.0.0.0"
      DYAD_PROXY_PORT_MIN: "${DYAD_PROXY_PORT_MIN:-50000}"
      DYAD_PROXY_PORT_MAX: "${DYAD_PROXY_PORT_MAX:-50100}"
      DYAD_USE_NPM: "true"
      NODE_ENV: "production"
      NODE_OPTIONS: "${NODE_OPTIONS:---max-old-space-size=4096}"
    volumes:
      - "${DYAD_HOST_DATA_PATH:-./dyad-data}:/data/dyad"
    ports:
      - "${DYAD_WEB_PORT:-4000}:${DYAD_WEB_PORT:-4000}"
      - "${DYAD_PROXY_PORT_MIN:-50000}-${DYAD_PROXY_PORT_MAX:-50100}:${DYAD_PROXY_PORT_MIN:-50000}-${DYAD_PROXY_PORT_MAX:-50100}"
    healthcheck:
      test: ["CMD", "node", "-e", "const http=require('http');const req=http.get('http://127.0.0.1:'+process.env.DYAD_WEB_PORT+'/api/health',res=>process.exit(res.statusCode===200?0:1));req.on('error',()=>process.exit(1));"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    logging:
      options:
        max-size: "10m"
        max-file: "5"
